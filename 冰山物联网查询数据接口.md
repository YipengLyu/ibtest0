# 冰山物联网开放平台接口文档
本文档是为了解决物联网平台与第三方应用平台数据对接提问题而提供的相关API说明资料，面向专业开发者提供协议对接，助力研发团队快速实现业务流程，从而提升研发效率，降低研发成本。

**变更履历**

|时间|版本|变更内容|变更者|备注|
| :-- | --- | --- | ---|---|
|2022-04-18|v1.0.0|初版发行|开尔文科技||




[TOC]

## **1. 开发概述**

冰山物联网开放平台是物联网设备连接和应用管理的平台，开发者通过创建应用、获得接口权限后便可以进行相关设备数据交互等操作，可以通过阅读本接口文档来帮助开发者快速完成功能开发。如遇问题，可与冰山物联网开放平台的开发者进行交流。

**请开发者注意**：


- 本协议采⽤HTTPS+JSON的传输⽅式，字符编码UTF-8
- HTTPS HEADER中，Content-Type为 Application/json
- 平台接口调用仅支持443端口
- 平台以Access Token为接口调用凭据，来调用接口，所有接口的调用需要先获取Access Token，Access Token在2小时内有效，过期需要重新获取。

**API概览**

| API            | 区分  | 功能描述         |
| -------------- | ----- | ---------------- |
| api/open/token | A-->S | 获取授权访问令牌 |
| api/open/data  | A-->S | 获取最新数据     |

*【注】A-->S：应用平台调用开放平台的接口，S-->A：开放平台调用应用平台的接口*

------



## **2. 数据安全策略说明**

### 2.1 数字签名验证

为了数据完整性与安全性，需要在每次调用接口中携带数字签名与Token。服务端会对数字签名进行验证，签名验证失败会拒绝数据请求，而Token则作为授权访问凭证通过Header进行传递，如果Token非法，同样会拒绝数据请求。

**签名规则**

按照接口定义中的签名字段和第三方应用唯一凭证密钥（AppSecret）的首字母升序（ASCII）进行MD5加密生成数字签名（sign)，加密后的字符串为32位大写。

以订单查询接口为例，请求参数如下：

| 属性      | 数据类型 | 是否必填 | 签名字段 | 说明              |
| --------- | -------- | -------- | -------- | ----------------- |
| taskNo    | integer  | 是       | 是       | 请求任务编号(0~9) |
| timestamp | long     | 是       | 是       | 时间戳            |
| sign      | string   | 是       | 否       | 数字签名          |

sign = MD5(taskNo=0&timestamp=1629980320978)

sign = E0A1C5BB26FD167E21DC6329787ABF6C

签名后的请求数据如下：

```json
{"taskNo":0,"timestamp":1629980320978,"sign":"E0A1C5BB26FD167E21DC6329787ABF6C"}
```



### 2.2 数据加密解密

数据加密采用对称加密规则AES方式，密钥为长度16位的appKey，iv偏移值为长度16位的appSecret，算法、模式、补码方式为 AES/CBC/PKCS7Padding，编码方式为UTF-8。如有疑问，请于开发者联系！

- 请求数据的加密范围是body的内容
- 返回数据的加密范围是data中的内容



## **3. 数据结构说明**

### 3.1 统一返回结构定义

调用接口后，平台将以统一结构进行数据返回。本文中若无特殊说明，返回参数说明参照此结构进行数据解析。

| 属性 | 数据类型 | 参数说明                   |
| ---- | -------- | -------------------------- |
| code | integer  | 返回码，详细参考返回码说明 |
| data | object   | 返回数据（JSON格式）       |
| msg  | string   | 错误信息                   |

### 3.2 全局返回码说明

每次调用接口时，可能获得正确或错误的返回码，开发者可以根据返回码信息调试接口，排查错误。

| 返回码 | 详细说明                                        |
| ------ | ----------------------------------------------- |
| 0      | 请求成功                                        |
| 1      | 请求失败                                        |
| 40001  | 获取访问凭证时 AppSecret 错误，或者 AppKey 无效 |
| 40002  | 访问凭证无效                                    |
| 40003  | 无效的数字签名                                  |
| 50001  | 请求的数据格式不正确                            |
| 50002  | 请求的数据不存在                                |
| 50003  | 不存在该任务                                    |



## **4. 接口详细定义**

### 4.1 获取数据列表

本接口将会提供采集数据列表。

**请求地址**

【请求方式：POST】https:// {host}/api/open/data

**请求参数**

| 属性      | 数据类型 | 是否必填 | 签名字段 | 说明                                        |
| --------- | -------- | -------- | -------- | ------------------------------------------- |
| targets   | [object] | 是       | 否       | 数据同步目标对象                            |
| + did     | [string] | 是       | 否       | 设备编号                                    |
| + gid     | [string] | 否       | 否       | 网关编号（当同一设备绑定2个以上网关时使用） |
| + pids    | [string] | 是       | 否       | 数据节点编号数组                            |
| startTime | [string] | 是       | 否       | 开始时间                                    |
| endTime   | [string] | 是       | 否       | 结束时间                                    |
| timestamp | long     | 是       | 是       | 时间戳                                      |
| sign      | string   | 是       | 否       | 数字签名                                    |

**请求说明**

- 请求数据示例：

  ```json
  {
      "targets": [
          {
              "did": "D001",
              "gid": "GW001",
              "pids": [
                  "P001",
                  "P002",
                  "P003"
              ]
          },
          {
              "did": "D001",
              "gid": "GW002",
              "pids": [
                  "P001",
                  "P002",
                  "P003"
              ]
          }
      ],
      "startTime": "2022-01-01 00:00:00",
      "endTime": "2022-03-01 00:00:00,
      "timestamp": 1629980320978,
      "sign": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  }
  ```



**响应参数（data部分）**

| 属性 | 数据类型 | 说明               |
| ---- | -------- | ------------------ |
| did  | string   | 设备编号           |
| gid  | string   | 网关编号           |
| data | [object] | 数据               |
| + pn | string   | 数据节点编号       |
| + pv | string   | 数据节点值         |
| + ts | long     | 时间戳（采集时间） |

**返回说明**

- 正常情况下，会返回下述JSON数据包给第三方商户平台：

  ```json
  {
      "code": 0,
      "data": [
          {
              "did": "D001",
              "gid": "GW001",
              "data": [
                  {
                      "pn": "P001",
                      "pv": "23.6",
                      "ts": 1629980320978
                  },
                  {
                      "pn": "P002",
                      "pv": "18",
                      "ts": 1629980320978
                  },
                  {
                      "pn": "P003",
                      "pv": "xxxxxx",
                      "ts": 1629980320978
                  }
              ]
          },
          {
              "did": "D001",
              "gid": "GW002",
              "data": [
                  {
                      "pn": "P001",
                      "pv": "23.6",
                      "ts": 1629980320978
                  },
                  {
                      "pn": "P002",
                      "pv": "18",
                      "ts": 1629980320978
                  },
                  {
                      "pn": "P003",
                      "pv": "xxxxxx",
                      "ts": 1629980320978
                  }
              ]
          }
      ],
      "msg": null
  }
  ```
  
- 错误时会返回错误码等信息，JSON数据包示例如下（该示例为token无效错误）:

  ```json
  {"code":40002,"data":null,"msg":"invalid token"}
  ```

***返回码：0，40002，40003，50001，50002***

------

> 此文档的所有权归大连开尔文科技有限公司所有，未经权利人许可任何组织或者个人不得以任何方式使用或传播。
